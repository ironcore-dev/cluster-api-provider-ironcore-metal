apiVersion: cluster.x-k8s.io/v1beta2
kind: Cluster
metadata:
  name: "${CLUSTER_NAME}"
  namespace: "${NAMESPACE}"
spec:
  clusterNetwork:
    pods:
      cidrBlocks: ["${POD_CIDR:=192.168.0.0/16}"]
    services:
      cidrBlocks: ["${POD_CIDR:=10.96.0.0/12}"]
  controlPlaneRef:
    apiGroup: controlplane.cluster.x-k8s.io
    apiVersion: controlplane.cluster.x-k8s.io/v1beta2
    kind: KubeadmControlPlane
    name: "${CLUSTER_NAME}-cp"
  infrastructureRef:
    apiGroup: infrastructure.cluster.x-k8s.io
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
    kind: IroncoreMetalCluster
    name: "${CLUSTER_NAME}"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: IroncoreMetalCluster
metadata:
  name: "${CLUSTER_NAME}"
  namespace: "${NAMESPACE}"
spec:
  controlPlaneEndpoint:
    host: foo
    port: 443
---
kind: KubeadmControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta2
metadata:
  name: "${CLUSTER_NAME}-cp"
  namespace: "${NAMESPACE}"
spec:
  replicas: ${CONTROL_PLANE_MACHINE_COUNT}
  version: "${KUBERNETES_VERSION}"
  machineTemplate:
    spec:
      infrastructureRef:
        apiGroup: infrastructure.cluster.x-k8s.io
        kind: IroncoreMetalMachineTemplate
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
        name: "${CLUSTER_NAME}-cp"
  kubeadmConfigSpec:
    initConfiguration:
      nodeRegistration:
        name: $${METAL_HOSTNAME}
        kubeletExtraArgs:
          - name: cloud-provider
            value: external
          - name: provider-id
            value: "ironcore://$${METAL_HOSTNAME}"
    clusterConfiguration:
      apiServer:
        extraArgs:
          - name: cloud-provider
            value: external
      controllerManager:
        extraArgs:
          - name: cloud-provider
            value: external
    joinConfiguration:
      nodeRegistration:
        name: $${METAL_HOSTNAME}
        kubeletExtraArgs:
          - name: cloud-provider
            value: external
          - name: provider-id
            value: "ironcore://$${METAL_HOSTNAME}"
    format: ignition
    ignition:
      containerLinuxConfig:
        additionalConfig: |-
          storage:
            files:
            - path: /opt/testdir/testfile
              filesystem: root
              mode: 0644
              contents:
                inline: |
                  [TEST]
                  test=1
    preKubeadmCommands:
      - hostnamectl set-hostname $${METAL_HOSTNAME}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: IroncoreMetalMachineTemplate
metadata:
  name: "${CLUSTER_NAME}-cp"
  namespace: "${NAMESPACE}"
spec:
  template:
    spec:
      serverSelector:
        matchLabels:
          server: metal
      image: ghcr.io/ironcore-dev/os-images/gardenlinux:1443.3
      metadata:
        foo: bar
      ipamConfig:
        - metadataKey: bond
          ipamRef:
            apiGroup: ipam.cluster.x-k8s.io
            kind: GlobalInClusterIPPool
            name: globalinclusterippool-sample-cp

---
apiVersion: cluster.x-k8s.io/v1beta2
kind: MachineDeployment
metadata:
  name: "${CLUSTER_NAME}-md-0"
  namespace: "${NAMESPACE}"
spec:
  clusterName: "${CLUSTER_NAME}"
  replicas: ${WORKER_MACHINE_COUNT}
  selector:
    matchLabels:
  template:
    metadata:
      labels:
    spec:
      clusterName: "${CLUSTER_NAME}"
      version: "${KUBERNETES_VERSION}"
      bootstrap:
        configRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta2
          kind: KubeadmConfigTemplate
          name: "${CLUSTER_NAME}-md-0"
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
        kind: IroncoreMetalMachineTemplate
        name: "${CLUSTER_NAME}-md-0"

---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta2
kind: KubeadmConfigTemplate
metadata:
  name: "${CLUSTER_NAME}-md-0"
  namespace: "${NAMESPACE}"
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          name: $${METAL_HOSTNAME}
          kubeletExtraArgs:
            cloud-provider: external
            provider-id: "ironcore://$${METAL_HOSTNAME}"
      format: ignition
      preKubeadmCommands:
        - hostnamectl set-hostname $${METAL_HOSTNAME}

---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: IroncoreMetalMachineTemplate
metadata:
  name: "${CLUSTER_NAME}-md-0"
  namespace: "${NAMESPACE}"
spec:
  template:
    spec:
      serverSelector:
        matchLabels:
          server: metal
      image: ghcr.io/ironcore-dev/os-images/gardenlinux:1443.3
      metadata:
        foo: bar
      ipamConfig:
        - metadataKey: bond
          ipamRef:
            apiGroup: ipam.cluster.x-k8s.io
            kind: GlobalInClusterIPPool
            name: globalinclusterippool-sample-cp